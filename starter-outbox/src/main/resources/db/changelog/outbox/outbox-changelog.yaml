databaseChangeLog:
  - changeSet:
      id: 001-create-outbox-table
      author: ru.outbox
      changes:
        - createTable:
            tableName: outbox
            columns:
              - column:
                  name: id
                  type: UUID
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: aggregate_type
                  type: VARCHAR(100)
                  constraints:
                    nullable: false
              - column:
                  name: aggregate_id
                  type: VARCHAR(200)
                  constraints:
                    nullable: false
              - column:
                  name: event_type
                  type: VARCHAR(100)
                  constraints:
                    nullable: false
              - column:
                  name: destination
                  type: VARCHAR(200)
                  remarks: "e.g. kafka:topicName | http:clientId:/path"
                  constraints:
                    nullable: false
              - column:
                  name: payload
                  type: TEXT
                  constraints:
                    nullable: false
              - column:
                  name: headers
                  type: JSONB
                  defaultValueComputed: "'{}'::jsonb"
                  constraints:
                    nullable: false
              - column:
                  name: status
                  type: VARCHAR(20)
                  remarks: "NEW | IN_PROGRESS | SENT | RETRY | DEAD"
                  constraints:
                    nullable: false
              - column:
                  name: retries
                  type: INT
                  defaultValueNumeric: 0
                  constraints:
                    nullable: false
              - column:
                  name: available_at
                  type: TIMESTAMPTZ
                  constraints:
                    nullable: false
              - column:
                  name: dedup_key
                  type: VARCHAR(200)
                  constraints:
                    nullable: true
              - column:
                  name: error_message
                  type: TEXT
                  constraints:
                    nullable: true
              - column:
                  name: created_at
                  type: TIMESTAMPTZ
                  defaultValueComputed: "now()"
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: TIMESTAMPTZ
                  defaultValueComputed: "now()"
                  constraints:
                    nullable: false

        - addUniqueConstraint:
            tableName: outbox
            columnNames: dedup_key
            constraintName: uq_outbox_dedup_key

        - createIndex:
            tableName: outbox
            indexName: idx_outbox_status_available_at
            columns:
              - column:
                  name: status
              - column:
                  name: available_at

        - createIndex:
            tableName: outbox
            indexName: idx_outbox_dest_status_available_at
            columns:
              - column:
                  name: destination
              - column:
                  name: status
              - column:
                  name: available_at

  # (опционально) триггер авто-обновления updated_at — через raw SQL
  - changeSet:
      id: 002-updated-at-trigger
      author: ru.outbox
      changes:
        - sql:
            splitStatements: false
            sql: |
              create or replace function set_updated_at()
              returns trigger as $$
              begin
                new.updated_at = now();
                return new;
              end;
              $$ language plpgsql;

              drop trigger if exists trg_outbox_set_updated_at on outbox;
              create trigger trg_outbox_set_updated_at
              before update on outbox
              for each row
              execute function set_updated_at();
